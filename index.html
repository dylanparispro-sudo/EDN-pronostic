<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EDN Picks</title>
  <style>
    :root{--bg:#0b1023;--card:#111827;--muted:#9ca3af;--text:#f8fafc;--accent:#3b82f6;--ok:#22c55e;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1023,#0f172a 35%,#0b1023);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px;margin-bottom:12px}
    h1{font-size:22px;margin:0 0 6px}
    label{font-size:12px;color:var(--muted)}
    input{width:100%;background:#0b1324;border:1px solid #283245;border-radius:10px;padding:8px 10px;color:#e5e7eb}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid #334155;background:#111827;color:#e5e7eb;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(120deg,var(--accent),#2563eb);border:none}
    .btn.ok{background:linear-gradient(120deg,#16a34a,#22c55e);border:none}
    .btn.danger{background:linear-gradient(120deg,#ef4444,#dc2626);border:none}
    .hint{font-size:12px;color:var(--muted)}
    .search{display:flex;gap:8px;margin:8px 0}
    .list{max-height:520px;overflow:auto;border:1px solid #1e2a3f;border-radius:10px}
    .item{display:flex;justify-content:space-between;gap:10px;padding:8px 10px;border-bottom:1px solid #213049}
    .item:last-child{border-bottom:none}
    .soft{opacity:.8;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #23314a;text-align:left}
    th{color:#a3b2c7}
    .pill{font-size:11px;padding:2px 6px;border-radius:8px;border:1px solid #334155;color:#cbd5e1}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>EDN Picks</h1>
    <p class="hint">Entre ton pseudo, choisis 10 items parmi la liste (recherche et cotes automatiques), puis enregistre. Une fois validé, tes choix seront bloqués.</p>

    <div class="card">
      <div class="row">
        <div style="flex:1 1 240px">
          <label>Pseudo</label>
          <input id="pseudo" placeholder="ex: Dydou"/>
        </div>
        <div style="align-self:flex-end;display:flex;gap:8px">
          <button class="btn primary" id="start">Commencer / Reprendre</button>
          <button class="btn danger" id="resetMine" title="Efface uniquement tes picks">Réinitialiser mes picks</button>
        </div>
      </div>
    </div>

    <div id="picker" class="card" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><span class="pill" id="who"></span></div>
        <div class="hint" id="selInfo">Sélectionnés: 0/10 • Total estimé: 0 pts</div>
      </div>
      <div class="search"><input id="search" placeholder="Rechercher un item..."/></div>
      <div class="list" id="itemsList"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn ok" id="savePicks">Enregistrer mes 10 picks</button>
        <button class="btn danger" id="clearPicks">Tout décocher</button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 6px">Tableau des joueurs</h3>
      <table id="board">
        <thead><tr><th>Joueur</th><th>Items (10)</th><th>Total estimé</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const MAX_SEL=10,BASE_PTS=3,KEY='edn-picks-github';
    const $=s=>document.querySelector(s);
    const h=(t,a={},c=[])=>{const e=document.createElement(t);Object.entries(a).forEach(([k,v])=>{if(k==='class')e.className=v;else if(k.startsWith('on'))e.addEventListener(k.substring(2),v);else e.setAttribute(k,v)});c.forEach(ch=>e.appendChild(typeof ch==='string'?document.createTextNode(ch):ch));return e};

    // State
    let ITEMS=[], SUM_FREQ=0;
    let db = (function(){try{return JSON.parse(localStorage.getItem(KEY))||{players:{}}}catch{return{players:{}}}})();
    let current={pseudo:'',picks:new Set(),locked:false};

    async function loadItems(){
      try{
        const res = await fetch('items.json', {cache:'no-store'});
        const arr = await res.json();
        ITEMS = arr.map((x,i)=>({id:Number(x.id)||i+1, name:String(x.name||'').trim(), freq:Number(x.freq)||0}));
        // tri par fréquence décroissante
        ITEMS.sort((a,b)=>(b.freq||0)-(a.freq||0));
        SUM_FREQ = ITEMS.reduce((s,i)=>s+(i.freq||0),0);
      }catch(e){ console.error('Erreur chargement items.json', e); ITEMS=[]; SUM_FREQ=0;}
    }

    function oddsFor(it){ const p = SUM_FREQ>0? Math.max(0.02, Math.min(0.9, (it.freq||0)/SUM_FREQ)) : 0.1; return {p,odds:(1/p)}; }
    function pointsFor(it){ const {odds}=oddsFor(it); return Math.max(1, Math.ceil(BASE_PTS*odds)); }

    function openPicker(){ $('#picker').style.display='block'; $('#who').textContent=current.pseudo; renderList(); updateInfo(); }

    function renderList(){
      const q = ($('#search').value||'').toLowerCase();
      const items = ITEMS.filter(i=> i.name.toLowerCase().includes(q));
      const list = $('#itemsList'); list.innerHTML='';
      items.forEach(it=>{
        const checked = current.picks.has(it.id);
        const {odds}=oddsFor(it);
        const row = h('div',{class:'item'},[
          h('div',{},[`#${it.id} — ${it.name}`]),
          h('div',{class:'soft'},[`Cote : ${odds.toFixed(2)} | Pts estimés : ${pointsFor(it)}`])
        ]);
        if(!current.locked){
          const chk = h('input',{type:'checkbox',checked:checked?true:false,onchange:e=>{
            if(e.target.checked){
              if(current.picks.size>=MAX_SEL){ e.target.checked=false; return alert('Limite 10 atteinte'); }
              current.picks.add(it.id);
            }else{
              current.picks.delete(it.id);
            }
            updateInfo();
          }});
          row.appendChild(chk);
        } else {
          if(checked) row.style.opacity='0.6';
        }
        list.appendChild(row);
      });
    }

    function updateInfo(){
      let total=0; current.picks.forEach(id=>{ const it=ITEMS.find(x=>x.id===id); if(it) total+=pointsFor(it); });
      $('#selInfo').textContent = `Sélectionnés: ${current.picks.size}/${MAX_SEL} • Total estimé: ${total} pts`;
    }

    function renderBoard(db){
      const tbody = $('#board tbody'); tbody.innerHTML='';
      Object.entries(db.players).forEach(([pseudo,rec])=>{
        let total=0;
        const labels=(rec.picks||[]).map(id=>{ const it=ITEMS.find(x=>x.id===id); if(!it) return `#${id}`; total+=pointsFor(it); return `#${it.id} ${it.name}`; });
        const tr = h('tr',{},[ h('td',{},[pseudo]), h('td',{},[ labels.join(' • ') ]), h('td',{},[ String(total) ]) ]);
        tbody.appendChild(tr);
      });
    }

    // Events
    $('#start').addEventListener('click',()=>{
      const v=$('#pseudo').value.trim();
      if(!v) return alert('Pseudo requis');
      const rec=db.players[v];
      current.pseudo=v;
      current.picks=new Set(rec?.picks||[]);
      current.locked=!!rec?.locked;
      openPicker();
    });
    $('#search').addEventListener('input', renderList);
    $('#clearPicks').addEventListener('click', ()=>{ if(current.locked) return; current.picks.clear(); renderList(); updateInfo(); });
    $('#savePicks').addEventListener('click', ()=>{
      if(current.locked) return alert('Déjà validé');
      if(current.picks.size!==MAX_SEL) return alert('Choisis exactement 10 items');
      db.players[current.pseudo] = {picks:Array.from(current.picks), locked:true};
      localStorage.setItem(KEY, JSON.stringify(db));
      current.locked=true;
      alert('Enregistré et verrouillé');
      renderBoard(db);
      renderList();
    });

    $('#resetMine').addEventListener('click', ()=>{
      const v=$('#pseudo').value.trim();
      if(!v) return alert('Entre d\'abord ton pseudo');
      if(!db.players[v]) return alert('Aucun pick enregistré pour ce pseudo');
      if(!confirm('Effacer définitivement tes picks ?')) return;
      delete db.players[v];
      localStorage.setItem(KEY, JSON.stringify(db));
      current={pseudo:v,picks:new Set(),locked:false};
      renderBoard(db);
      renderList();
      updateInfo();
      alert('Tes picks ont été réinitialisés (les autres sont inchangés).');
    });

    (async function init(){
      await loadItems();
      renderBoard(db);
    })();
  </script>
</body>
</html>
